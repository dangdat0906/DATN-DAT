@using APP.UTILS
@{

    Layout = "~/Views/Shared/_Layout.cshtml"; }
    <div id="frmCreate" class="form-group">
        <div class="form-group row">
            <div class="col-sm-2">
                <label required class="col-form-label">Tiêu đề</label>
            </div>
            <div class="col-sm-10">
                <input type="text" required class="form-control" id="txtTitle" placeholder="Tên tiêu đề">
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label required for="dlContentType" class="col-form-label">Thể loại tin</label>
            </div>
            <div class="col-sm-4">
                <select required id="dlContentType" class="form-control" style="width: 100%;"></select>
            </div>
            <div class="col-sm-2 text-right">
                <label required for="dlNewsSource" class="col-form-label">Nguồn tin</label>
            </div>
            <div class="col-sm-4">
                <select required id="dlNewsSource" class="form-control select2" style="width: 100%;"></select>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label required class="col-form-label">Chuyên mục</label>
            </div>
            <div class="col-sm-4">
                <select required id="dlCategoryContent" multiple data-placeholder="Chọn chuyên mục" style="width: 100%;"></select>
            </div>
            <div class="col-sm-2 text-right">
                <label required class="col-form-label">Tác giả</label>
            </div>
            <div class="col-sm-4">
                <select required id="dlAuthor" class="select2 form-control" style="width: 100%;"></select>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label for="txtUrl" class="col-form-label">Đường dẫn(Url)</label>
            </div>
            <div class="col-sm-10">
                @*<div class="input-group">
                <div class="input-group-prepend">
                    <button type="button" id="btnUrl" class="btn btn-primary">Tạo</button>
                </div>*@
                <!-- /btn-group -->
                <input type="text" placeholder="Đường dẫn bài viết" id="txtUrl" class="form-control">
                @*</div>*@
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label for="txtImageUrl" class="col-form-label">Ảnh tiêu đề</label>
            </div>
            <div class="col-sm-10">
                <div class="input-group">
                    <div class="custom-file">
                        <input type="file" accept="image/*" class="custom-file-input" name="files" id="files">
                        <label class="custom-file-label" for="fileImage">Chọn file</label>
                    </div>
                </div>
            </div>
        </div>
        @*<div class="form-group row">
            <div class="col-sm-2">
                <label>Tiêu điểm</label>
            </div>
            @{
                if ((int)ViewData[nameof(RolesEnum.Approval)] == 1)
                {
                    <div class="row align-items-center col-sm-10">
                        <div class="col-sm-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="ckbShowOnTop">
                                <label class="form-check-label" for="ckbShowOnTop">Đưa lên đầu(Trái)</label>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="ckbShowOnRightTop">
                                <label class="form-check-label" for="ckbShowOnRightTop">Đưa lên đầu(Phải)</label>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="row align-items-center col-sm-10">
                        <div class="col-sm-3">
                            <div class="form-check">
                                <input type="checkbox" disabled class="form-check-input" id="ckbShowOnTop">
                                <label class="form-check-label" for="ckbShowOnTop">Đưa lên đầu(Trái)</label>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-check">
                                <input type="checkbox" disabled class="form-check-input" id="ckbShowOnRightTop">
                                <label class="form-check-label" for="ckbShowOnRightTop">Đưa lên đầu(Phải)</label>
                            </div>
                        </div>
                    </div>
                }

            }

        </div>*@
        <div class="form-group row">
            <div class="col-sm-2">
                <label class="col-form-label" required for="dtPublishedDate">Ngày đăng tải</label>
            </div>
            <div class="col-sm-10">
                <div class="input-group col-sm-4">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="far fa-calendar-alt"></i>
                        </span>
                    </div>
                    <input type="text" autocomplete="off" required placeholder="Ngày đăng tải" class="form-control float-right datepicker" id="dtPublishedDate">
                </div>
            </div>
        </div>
        @*<div class="form-group row">
            <div class="col-sm-2">
                <label class="col-form-label" for="txtSource">Nguồn/Tác giả</label>
            </div>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="txtSource" placeholder="Nguồn/Tác giả">
            </div>
        </div>*@
        <div class="form-group row">
            <div class="col-sm-2">
                <label class="col-form-label" for="txtSummary">Trích dẫn</label>
            </div>
            <div class="col-sm-10">
                <textarea style="height:100px" class="form-control" id="txtSummary"></textarea>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label class="col-form-label">Nhóm tin/Hastag</label>
            </div>
            <div class="col-sm-10 row">
                <div class="col-sm-5">
                    <select id="dlGroup" class="select2 form-control" multiple="multiple" data-placeholder="Chọn nhóm tin/HasTag" style="width: 100%;"></select>
                </div>
                <a href="javascript:;" class="my-auto" id="btnCreateGroup"><i class="fas fa-plus-circle"></i></a>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-2">
                <label class="col-form-label" for="txtContent">Nội dung</label>
            </div>
            <div class="col-sm-10">
                <textarea class="textarea" id="txtContent"></textarea>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-6">
                <button id="btnSaveContent" style="float:right" class="btn btn-primary">Lưu</button>
            </div>
            <div class="col-sm-6">
                <button id="btnClose" style="float:left" class="btn btn-danger">Trở về</button>
            </div>
        </div>
    </div>
<script>
    var frmCreate = $('#frmCreate');
    var urlDomain = "/bai-viet";
    $(document).ready(function () {
        addRequired(frmCreate);
        setCategory();
        $('.select2').select2();
        bsCustomFileInput.init();
        setTextArea();
        setButton();
        setDatetimeForCreateContent()
        //setEmptyDateTime()
        setGroup();
        setType();
        setNewsSource();
        //setAuthor();

    });

    function setButton() {
        $('#frmCreate').find('#btnSaveContent').off("click").on('click', function (e) {
            e.preventDefault();
            uploadTitleImage();

        });
        $('#frmCreate').find('#btnClose').off("click").on('click', function (e) {
            e.preventDefault();
            returnIndex();
        });
        $('#frmCreate').find('#txtTitle').on('blur', function (e) {
            CreateUrl();
        });
        $('#frmCreate').find('#btnCreateGroup').off("click").on("click", function (e) {
            e.preventDefault();
            openCreateGroup();
        })
    }
    function setType() {
        $('#frmCreate').find('#dlContentType').select2()
        $.ajax({
            url: urlDomain + "/contenttype-lookup",
            method: "GET",
            success: function (response) {
                $.each(response.data, function (i, item) {
                        var newOption = new Option(item.title, item.value, false, true);
                    $('#frmCreate').find("#dlContentType").append(newOption);
                })
            }
        }).then(function () {
            $('#frmCreate').find("#dlContentType").val(@((int)ContentTypeEnum.Normal)).trigger('change');
        })
    }
    function create(titleImg, imgWidth, imgHeight) {
        if (ValidateForm(frmCreate)) {
            return;
        }
        //var txtTag = $('#frmCreate').find('#txtTag').val().trim().replace(/[`“”"~!@@#$%^&*()_|+\-=?;:'".<>\{\}\[\]\\\/]/gi,'')
        showLoading();
        var dateString = $('#frmCreate').find('#dtPublishedDate').val().replaceAll('/', '-');
        var publishedDate = moment(convertToDateTime(dateString)).format('YYYY-MM-DD HH:mm:ss');
        $.ajax({
            url: urlDomain + "/create",
            method: "POST",
            data: {
                Title: $('#frmCreate').find('#txtTitle').val(),
                Summary: $('#frmCreate').find('#txtSummary').val(),
                Content: $('#frmCreate').find('#txtContent').val(),
                //Source: $('#frmCreate').find('#txtSource').val(),
                Url: $('#frmCreate').find('#txtUrl').val(),
                Status: @((int)ContentStatusEnum.Approving), //if(user.role = nguoi viet) stt = 2 (cho duyet)
                //PublishDate: publishedDate,
                TitleImage: titleImg,
                ContentType: $('#frmCreate').find('#dlContentType').val(),
                ShowOnTop: $('#frmCreate').find('#ckbShowOnTop').prop("checked") ? true : false,
                //ShowOnRightTop: $('#frmCreate').find('#ckbShowOnRightTop').prop("checked") ? true : false,
                GroupID: $('#frmCreate').find('#dlGroup').val(),
                CategoryId: $('#frmCreate').find('#dlCategoryContent').val(),
                TitleImgWidth: imgWidth,
                TitleImgHeight: imgHeight,
                NewsSource: $('#frmCreate').find('#dlNewsSource').val(),
                AuthorId: $('#frmCreate').find("#dlAuthor").val()
                //PublishDate
                //LangCode :
                //CreatedBy :
            }
            , success: function (response) {
                hideLoading()
                if (response.result) {
                    // datasource = response.data
                    showAlert(response.message, 2)
                    hideContentModal()
                    setTimeout(function () { returnIndex(); showLoading(); }, 1500);
                } else {
                    showAlert(response.message)
                }
            }
        });
    }
    function setEmptyDateTime() {
        $('#frmCreate').find('#dtPublishedDate').val('');
    }
    function setGroup() {
        $.ajax({
            url: urlDomain + "/group-lookup",
            method: "GET",
            success: function (response) {
                $.each(response.data, function (i, item) {
                    //if(user.role = )
                    var newOption = new Option(item.title, item.value);
                    $('#frmCreate').find("#dlGroup").append(newOption);
                })
            }
        })
    }
    function openCreateGroup() {
        $.ajax({
            url: urlDomain + "/tao-moi-group",
            method: "GET",
            success: function (response) {
                showContentModal(response, "Tạo mới nhóm tin")
            }
        });
    }
    function CreateUrl() {
        var date = new Date()
        var random = ""
        var hh = (date.getHours() < 10 ? '0' : '') + date.getHours();
        var mn = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
        var sc = (date.getSeconds() < 10 ? '0' : '') + date.getSeconds();
        random = hh + mn + sc
        if (frmCreate.find('#txtTitle').val().length > 0) {
            frmCreate.find('#txtUrl').val(removeAccents(frmCreate.find('#txtTitle').val() + "-" + random));
        }
        else {
            frmCreate.find('#txtUrl').val('')
        }

    }
    function returnIndex() {
        //showLoading();
        $(location).attr('href', urlDomain + "/danh-sach");
    }
    function setCategory() {
        $.ajax({
            url: urlDomain + "/category-getlistchild",
            method: "GET",
            success: function (response) {
                    $('#frmCreate').find("#dlCategoryContent")
                        .select2ToTree({ treeData: { dataArr: response.data, valFld: "id", labelFld: "name", incFld: "listChild" }, maximumSelectionLength: 30 });
            }
        })
    }
    function setNewsSource() {
        $.ajax({
            url: urlDomain + "/news-sources",
            method: "GET",
            success: function (response) {
                $.each(response.data, function (i, item) {
                    var newOption = new Option(item.title, item.value);
                    $('#frmCreate').find("#dlNewsSource").append(newOption);
                })
            }
        }).then(function () {
            setAuthor($('#frmCreate').find("#dlNewsSource").val())
        })
    }
    function uploadTitleImage() {
        var imageUrl = "";
        var imgWidth, imgHeight;
        var fileUpload = frmCreate.find('#files').get(0);
        var files = fileUpload.files;
        if (files.length < 1) {
            create("", "", "")
        }
        else {
            var allowedExtensions =
                /(\.jpg|\.jpeg|\.png|\.gif|\tiff|\raw|\psd)$/i;
            if (!allowedExtensions.exec(fileUpload.value)) {
                showAlert('Không đúng định dạng ảnh');
                fileUpload.value = '';
                return false;
            }
            var fileData = new FormData();
            var obj = {
                "Type" : @((int)MediaTypeEnum.Image),
                "Folder": "TitleImage"
            }
            for (var i = 0; i < files.length; i++) {
                fileData.append("files", files[i]);
                fileData.append("obj", JSON.stringify(obj));
            }
            $.ajax({
                url: "/da-phuong-tien" + "/create-or-update",
                method: "POST",
                data: fileData,
                processData: false,
                contentType: false
                , success: function (response) {
                    hideLoading()
                    if (response.result) {
                        // datasource = response.data
                        imageUrl = response.url
                        imgWidth = response.width;
                        imgHeight = response.height;
                    }
                }
            }).then(function (response) {
                if (response.result) {
                    create(imageUrl, imgWidth, imgHeight)
                }
                else {
                    showAlert("Có lỗi xảy ra khi up ảnh")
                    return;
                }
            });
        }
    }
    function BrowserServer() {
        var title = "Thư viện";
        $.ajax({
            url: urlDomain + "/thu-vien-media",
            method: "Get",
            success: function (response) {
                showMediaModal(response, title)
            }
        })
    }
    function UploadImage(file) { //Upload file image from summernote arena to our server then insert image to textarea by image url
        if ($('#frmCreate').find("#dlCategoryContent").val().length < 1) {
            showAlert('Chưa chọn chuyên mục')
            return;
        }
        var obj = {
            "Type": @((int)MediaTypeEnum.Image),
            "Folder": normalVNese($('#frmCreate').find("#dlCategoryContent option:selected").first().text())
        }
        var formData = new FormData();
            formData.append("files", file);
            formData.append("obj", JSON.stringify(obj))
            $.ajax({
                url: "/da-phuong-tien" + "/create-or-update",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    //editor.insertImage(welEditable, res.url);
                    $("#txtContent").summernote("insertImage", location.origin + '/' + response.url, '');
                }
            });
    }
    function setAuthor(newsSourceId = 0) {
        $.ajax({
            url: "/tac-gia" + "/lookup?newsSourceId=" + newsSourceId,
            method: "GET",
            success: function (response) {
                $('#frmCreate').find("#dlAuthor").empty();
                $.each(response.data, function (i, item) {
                    var newOption = new Option(item.title, item.value);
                    $('#frmCreate').find("#dlAuthor").append(newOption);
                })
            }
        })
    }
    $('#frmCreate').find("#dlNewsSource").on('change', function () {
        var newsSourceId = 0;
        newsSourceId = this.value;
        setAuthor(newsSourceId)
    })
    function setDatetimeForCreateContent(type) {//Set all element that have class = datepicker to daterangepicker plugin
        $('.datepicker').daterangepicker({ // allow set single datetime
            singleDatePicker: true,
            startDate: new Date(),
            timePicker: true,
            locale: {
                format: "DD/MM/YYYY HH:mm:ss",
                cancelLabel: 'Xóa',
                applyLabel: 'Lưu'
            }
        });
        $('.datepicker').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
    }


</script>